<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
</head>
<body>
<div th:replace="fragments/bodyHeader :: bodyHeader"></div>
<h3 style="text-align: center; color: #386ad1; margin-top: 100px;">View Meeting</h3>
<div class="meetingContainer" style="text-align: center;">
    <div class="col-7" style="display:inline-block; width: 700px;">
        <form id="EditForm" th:object="${team}">
            <div class="form-group row">
                <label class="col-sm-4 col-form-label" for="meetingName">모임 이름</label>
                <div class="col-sm-8">
                    <input type="text" name="meetingName" id="meetingName" th:value="*{teamName}" class="form-control"
                           readonly/>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-4 col-form-label">모임 멤버</label>
                <div class="col-sm-8" id="plususers">
                    <div class="btn-group" role="group">
                        <div class="col-sm-8">
                            <input type="text" name="users" id="users" class="form-control" size="50"
                                   placeholder="멤버 아이디를 입력해주세요."/>
                        </div>
<!--                        <div class="col-sm-2">-->
<!--                            <input type="button" value="추가" id="usersplus" class="btn btn-outline-light"/>-->
<!--                        </div>-->
                    </div>
                    <div class="mb-3 row" id="pu"></div>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-4 col-form-label" for="meetingPlace">모임 장소</label>
                <div class="col-sm-8">
                    <select id="meetingPlace" class="form-control" style="font-size: 14px" th:value="*{place}">
                        <option>중간 지점</option>
                        <option>직접 지정</option>
                    </select>
                    <input type="text" class="form-control" id="writePlace" name="writePlace" style="padding-left: 20px"
                           hidden>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-4 col-form-label" for="meetingDate">모임 날짜</label>
                <div class="col-sm-8">
                    <input type="datetime-local" onchange="setMinValue()" name="meetingDate" id="meetingDate"
                           class="form-control" style="color:#00000090" th:value="*{date}"/>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-sm-12">
                </div>
            </div>
        </form>
    </div>
</div>

<div class="d-grid gap-2 d-md-flex justify-content-md-end" style="padding: 0px; border: 0px; width: 700px; text-align: center;">
    <div id="deleteBtn" style="border-radius: 0.5rem; height: 10px; width: 20px;"></div>
    <div id="updateBtn" style="border-radius: 0.5rem; height: 10px; width: 20px;"></div>
</div>

<hr class="h-divider" style="margin-top: 20px; margin-left: 700px; display:inline-block; width: 700px;">
<form>
    <div class="form-group" style="margin-bottom: 10px; margin-left: 700px; display:inline-block; width: 700px;">
        <div class="row">
            <h4>comment</h4>
        </div>
        <div class="row" style="display:inline-block; width:700px;">
            <textarea class="form-group col-11" rows="2" id="comment" placeholder="내용을 입력해주세요"></textarea>
            <button type="button" class="btn btn-outline-light" id="btn"
                    style="background-color: #283C82; border-color: #00000030; font-size: 15px; height: 50px;  display:inline-block; width: 70px;">
                등록
            </button>
        </div>
    </div>
</form>

<form style="margin-top: 60px; margin-left: 700px; display:inline-block;">
    <div>
        <div id="commentList">
        </div>
    </div>
</form>

<style>
    #usersplus{
        height: 35px;
        font-size: 14px;
        /*padding: 1rem;*/
        background-color: #283C82;
        border: 1px solid #b1b1b1;
        color: #FFFFFF;
        border-radius: 0.3rem;
    }
</style>

<script>
    let curURL = window.location.href;
    let urlArr = curURL.split("/");
    let idx = urlArr[urlArr.length - 1];

    $(document).ready(function () {
        // findContent();
        findComment();
        // deleteContent();

        $("#btn").on('click', function () {
            saveComment();
        })
    });

    function saveComment() {
        if ($('#comment').val() == "") {
            $("#comment").attr('placeholder', '최소 한글자 이상을 입력하세요.');
        } else {
            $.ajax({
                url: "/saveComment",
                type: "GET",
                data: {
                    comment: $("#comment").val(),
                },
                success: function (data) {
                    let commentList = document.getElementById('commentList');

                    let div1 = document.createElement('form');
                    div1.setAttribute('class', 'row');
                    div1.setAttribute('id', data.cmID + 'div');
                    div1.setAttribute('style', 'margin-bottom: 40px; width: 700px;');
                    let div2 = document.createElement('div')
                    div2.setAttribute('class', 'col-auto');
                    div2.setAttribute('style', 'margin-top: 30px;, margin-right: 30px;, font-weight: bold');
                    let input = document.createElement('input');
                    input.setAttribute('class', 'form-control');
                    let name = document.createElement('div');
                    name.setAttribute('class', 'col-2')
                    name.setAttribute('style', 'margin-right: 30px;');
                    name.innerHTML = "🙂 " + data.writerName + "님의 댓글  ";
                    let content = document.createElement('input');
                    content.setAttribute('type', 'text');
                    content.setAttribute('value', data.commentContent);
                    content.setAttribute('id', data.cmID);
                    content.setAttribute('name', 'comments');
                    content.setAttribute('class', 'col-8');
                    content.setAttribute('style', 'border:1px solid #00000020; margin-right: 10px;')

                    div1.appendChild(name);
                    div1.appendChild(content);

                    // 수정버튼 생성
                    let updateComment = document.createElement('button');
                    updateComment.setAttribute('type', 'button');
                    updateComment.setAttribute('class', 'btn btn-outline-light');
                    updateComment.setAttribute('style', 'background-color: #283C82; border-color: #00000030; width: 70px; font-size: 15px; margin-left:10px;')

                    updateComment.innerHTML = "수정";
                    div1.appendChild(updateComment);

                    // 삭제버튼 생성
                    let delComment = document.createElement('button');
                    delComment.setAttribute('type', 'button');
                    delComment.setAttribute('class', 'btn btn-outline-light');
                    delComment.setAttribute('style', 'background-color: #283C82; border-color: #00000030; width: 70px; font-size: 15px; margin-left:10px;')

                    delComment.innerHTML = "삭제";
                    div1.appendChild(delComment);
                    commentList.appendChild(div1);

                    $("#comment").val("");

                    // 댓글 삭제
                    delComment.addEventListener("click", () => {
                        $.ajax({
                            url: "/deleteComment",
                            type: "GET",
                            dataType: "json",
                            data: {
                                cmID: data.cmID,
                            },
                            success: function (res) {
                                if (res == true) {
                                    $('#' + data.cmID + 'div').remove()
                                }
                            }, error: function () {
                                alert("댓글 삭제 에러");
                                window.location.replace('/boardSearch');
                            }
                        });
                    });
                    // 댓글 수정
                    updateComment.addEventListener("click", () => {
                        let comments = document.getElementById(data.cmID)

                        $.ajax({
                            url: "/updateCommentSave", //댓글 수정하기 버튼 누르고 나오는 수정하기 버튼
                            type: "GET",
                            dataType: "json",
                            data: {
                                cmID: data.cmID,
                                commentContent: comments.value
                            },
                            success: function (data) {
                                if (data == true) {
                                }
                            }
                        });
                    })
                }
            });
        }
    }

    // $.ajax({
    //     url: "/checkUser",
    //     type: "POST",
    //     success: function (data) {
    //         console.log('성공')
    //         console.log(data)
    //         if (data == 0) {
    //             $('#comment').attr('readonly', 'true')
    //             $('#comment').attr('placeholder', '회원만 이용할 수 있습니다.')
    //         }
    //     }
    // })


    function findComment() {
        $.ajax({
            url: "/findComment",
            type: "GET",
            success: function (data) {
                let commentList = document.getElementById('commentList');
                data.forEach(function (comment) {
                    let div1 = document.createElement('form');
                    div1.setAttribute('class', 'row');
                    div1.setAttribute('id', comment.cmID + 'div');
                    div1.setAttribute('style', 'margin-bottom: 40px; width: 700px;');
                    let div2 = document.createElement('div')
                    div2.setAttribute('class', 'col-auto');
                    div2.setAttribute('style', 'margin-top: 30px;, margin-right: 30px;, font-weight: bold');
                    let input = document.createElement('input');
                    input.setAttribute('class', 'form-control');
                    let name = document.createElement('div');
                    name.setAttribute('class', 'col-2')
                    name.setAttribute('style', 'margin-right: 30px;');
                    name.innerHTML = "🙂 " + comment.writerName + "님의 댓글  ";
                    let content = document.createElement('input');
                    content.setAttribute('type', 'text');
                    content.setAttribute('value', comment.commentContent);
                    content.setAttribute('id', comment.cmID);
                    content.setAttribute('name', 'comments');
                    content.setAttribute('class', 'col-8');
                    content.setAttribute('style', 'border:1px solid #00000020')
                    div1.appendChild(name);
                    div1.appendChild(content);

                    // 수정버튼 생성
                    let updateComment = document.createElement('button');
                    updateComment.setAttribute('type', 'button');
                    updateComment.setAttribute('class', 'btn btn-outline-light');
                    updateComment.setAttribute('style', 'background-color: #283C82; border-color: #00000030; width: 70px; font-size: 15px; margin-left:10px')

                    updateComment.innerHTML = "수정";
                    div1.appendChild(updateComment);

                    // 삭제버튼 생성
                    let delComment = document.createElement('button');
                    delComment.setAttribute('type', 'button');
                    delComment.setAttribute('class', 'btn btn-outline-light');
                    delComment.setAttribute('style', 'background-color: #283C82; border-color: #00000030; width: 70px; font-size: 15px; margin-left:10px')

                    delComment.innerHTML = "삭제";
                    div1.appendChild(delComment);


                    // 작성자가 아니면 숨기기
                    $.ajax({
                        url: "/updateCommentCheck",
                        type: "GET",
                        data: {
                            cmID: comment.cmID
                        },
                        success: function (data) {
                            if (data == false) {
                                content.setAttribute('style', 'border:none')
                                updateComment.setAttribute('hidden', 'true')
                                content.setAttribute('readOnly', 'true')
                            }
                        }
                    });
                    // 로그인 유저 및 작성자가 아니면 숨기기
                    $.ajax({
                        url: "/deleteCommentCheck",
                        type: "GET",
                        data: {
                            cmID: comment.cmID
                        },
                        success: function (data) {
                            if (data == false) {
                                delComment.setAttribute('hidden', 'true')
                                content.setAttribute('readOnly', 'true')

                            }
                        }
                    });

                    // 댓글 삭제
                    delComment.addEventListener("click", () => {
                        $.ajax({
                            url: "/deleteComment",
                            type: "GET",
                            dataType: "json",
                            data: {
                                cmID: comment.cmID,
                            },
                            success: function (data) {
                                if (data == true) {
                                    $('#' + comment.cmID + 'div').remove()
                                }
                            }, error: function () {
                                alert("댓글 삭제 에러");
                                window.location.replace('/boardSearch');
                            }
                        });
                    });
                    // 댓글 수정
                    updateComment.addEventListener("click", () => {
                        let comments = document.getElementById(comment.cmID)

                        $.ajax({
                            url: "/updateCommentSave", //댓글 수정하기 버튼 누르고 나오는 수정하기 버튼
                            type: "GET",
                            dataType: "json",
                            data: {
                                cmID: comment.cmID,
                                commentContent: comments.value
                            },
                            success: function (data) {
                                if (data == true) {
                                    // window.location.replace('/detailContent/' + idx);
                                }
                            }
                        });
                    })

                    commentList.appendChild(div1);
                });
            }
        });
    }
</script>
<div th:replace="fragments/footer :: footer"></div>
</body>
</html>